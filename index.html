<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>SpeakHER</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles2.css" rel="stylesheet" />
        <link href="css/styles.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <script src="https://webgazer.cs.brown.edu/webgazer.js?"></script>
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light shadow-sm">
            <div class="container px-4 px-lg-5">
                <img class="navbar-brand" src="assets/speaker.png" width="60" height="60">
                <a class="navbar-brand " href="main.html">SpeakHER</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                        <li class="nav-item"><a class="nav-link " aria-current="page" href="main.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link active" href="index.html">Practice</a></li>
                        <li class="nav-item"><a class="nav-link" href="videos.html">My Videos</a></li>
                    </ul>
                    <form class="d-flex">
                        <button class="btn btn-outline-dark" type="submit">
                            <i class="bi-person-fill me-1"></i>
                            Sign in
                        </button>
                    </form>
                </div>
            </div>
        </nav>
        <!-- Product section-->
        <section class="py-33 bg-pink">
            <div class="container px-4 px-lg-5 my-0">
                <div class="row gx-4 gx-lg-5 align-items-center">
                    <div>
                        <div class="d-flex justify-content-center">
                            <input class="justify-content-center display-5 fw-bolder mb-4" id="inputTitle" style="max-width: 100%;" placeholder="Title..."/>
                        </div>
                        <div class="d-flex justify-content-center mb-5">
                            <button id="start" class="btn btn-primary btn-xl rounded-pill fw-bolder" style="margin-right:0.5rem ">Open Camera</button>
                            <button id="record" class="btn btn-primary btn-xl rounded-pill fw-bolder" style="margin-right:0.5rem " disabled>Record</button>
                            <button id="play" class="btn btn-primary btn-xl rounded-pill fw-bolder" disabled>Play Recording</button>
                            <p>
                                <div id="echoCancellation"> </div>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6" id="hidden1" style="display: none;">
                        <div class="d-flex justify-content-center">
                          <p class="content lead mb-1" id="alerts"></p>
                        </div>
                        <div class="d-flex justify-content-center">
                            <canvas class="mb-1" id="meter" width="500" height="50"></canvas>
                        </div>
                        <div class="d-flex justify-content-center">
                            <p class="content lead mb-5" id="volumeLevel"></p>
                        </div>
                        <div class="d-flex justify-content-center">
                            <p class="content lead mb-5" id="gazeTracker"></p>
                        </div>
                    </div>
                    <div class="col-md-6 mb-5" id="hidden2" style="display: none;">
                        <video id="camera2" class="card-img-top mb-md-0 align-top"  playsinline autoplay muted></video>
                    </div>
                    <div style="padding-top:0;">
                        <p class="spoken lead mb-5" style="border-style: inset; padding-left: 10px; padding-left:10px;padding-bottom:100px;padding-top:10px;background-color: rgb(248,248,248);">Text from your presentation...
                        </p>
                        <div class="d-flex justify-content-center">
                            <button id="save2" class="btn btn-primary btn-xl rounded-pill fw-bolder" style="margin-right:0.5rem ">Save</button>
                            <button id="score" class="btn btn-primary btn-xl rounded-pill fw-bolder"disabled onclick="openForm()">Results</button>
                        </div>
                        <div id="msg">
                          <pre></pre>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section class="py-3 bg-light">
          <div class="justify-content-center" style="padding-left:400px;">
            <div class="form-popup mb-5 mt-5" id="myForm">
              <form action="/action_page.php" class="form-container ">
                <div class="d-flex justify-content-center">
                  <p class="display-5 fw-bolder mb-5">Score</p>
                </div>

                <label for="email" id="totalFillerWords"><b class="lead fw-bolder">Filler Words: </b></label>
                <p class="lead mb-5" id="numberofFillerWords"></p>

                <label for="email" ><b class="lead fw-bolder">Speech Volume: </b></label>
                <p class="lead mb-5" id="speech volume">Good <input type="checkbox" checked="checked">  <span class="checkmark"></span></p>

                <label for="email" ><b class="lead fw-bolder">Eye Contact: </b></label>
                <p class="lead mb-5" id="speech volume">Good <input type="checkbox" checked="checked">  <span class="checkmark"></span></p>

                <button type="button" class="btn btn-primary btn-xl rounded-pill fw-bolder" style="background-color: #F2C83F;border-color: #F2C83F" onclick="closeForm()">Close</button>
              </form>
              </div>
            </div>
        </section>
        <!-- Related items section-->
        <section class="py-3 bg-white">
            <div class="container px-4 px-lg-5 mt-5">
                <h2 class="fw-bolder mb-4">Recent Videos</h2>
                <div class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
                    <div class="col mb-5">
                        <div class="card h-85">
                            <!-- Product image-->
                            <canvas class="card-img-top" id="savedVideo"></canvas>
                            <!-- Product details-->
                            <div class="card-body p-3">
                                <div class="text-center">
                                    <!-- Product name-->
                                    <h5 class="fw-bolder" id="savedTitle"></h5>
                                </div>
                            </div>
                            <!-- Product actions-->
                            <div class="card-footer p-5 pt-0 border-top-0 bg-transparent">
                                <div class="text-center"><a class="btn btn-primary btn-xl rounded-pill fw-bolder" href="#">Play</a></div>
                            </div>
                        </div>
                    </div>
                    <div class="col mb-5">
                        <div class="card h-85">
                            <div class="card-body">
                                <div class="text-center">
                                    <!-- Product name-->
                                    <i class="fa fa-plus p-5" style="font-size:70px;color:grey" href="#"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col mb-5">
                        <div class="card h-85">
                            <div class="card-body">
                                <div class="text-center">
                                    <!-- Product name-->
                                    <i class="fa fa-plus p-5" style="font-size:70px;color:grey" href="#"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col mb-5">
                        <div class="card h-85">
                            <div class="card-body">
                                <div class="text-center">
                                    <!-- Product name-->
                                    <i class="fa fa-plus p-5" style="font-size:70px;color:grey" href="#"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Footer-->
        <footer class="bg-dark text-center py-5">
            <div class="container px-5">
                <div class="text-white-50 small">
                    <!-- Footer-->
                    <div class="container"><p class="m-0 text-center text-white"> &copy; SpeakHER 2021</p></div>
                    <a >Privacy</a>
                    <span class="mx-1">&middot;</span>
                    <a >Terms</a>
                    <span class="mx-1">&middot;</span>
                    <a >FAQ</a>
                </div>
            </div>
        </footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
        <script>
          var audioContext = null;
          var meter = null;
          var canvasContext = null;
          var WIDTH=500;
          var HEIGHT=50;
          var rafID = null;
          
          //if (document.getElementById("record").disabled == false)
          //{
            //startVM();
          //}
          function startVM() {

              // grab our canvas
            canvasContext = document.getElementById( "meter" ).getContext("2d");
            
              // monkeypatch Web Audio
              window.AudioContext = window.AudioContext || window.webkitAudioContext;
            
              // grab an audio context
              audioContext = new AudioContext();

              // Attempt to get audio input
              try {
                  // monkeypatch getUserMedia
                  navigator.getUserMedia = 
                    navigator.getUserMedia ||
                    navigator.webkitGetUserMedia ||
                    navigator.mozGetUserMedia;

                  // ask for an audio input
                  navigator.getUserMedia(
                  {
                      "audio": {
                          "mandatory": {
                              "googEchoCancellation": "false",
                              "googAutoGainControl": "false",
                              "googNoiseSuppression": "false",
                              "googHighpassFilter": "false"
                          },
                          "optional": []
                      },
                  }, onMicrophoneGranted, onMicrophoneDenied);
              } catch (e) {
                  alert('getUserMedia threw exception :' + e);
              }

          }

          function onMicrophoneDenied() {
              alert('Stream generation failed.');
          }

          var mediaStreamSource = null;

          function onMicrophoneGranted(stream) {
              // Create an AudioNode from the stream.
              mediaStreamSource = audioContext.createMediaStreamSource(stream);

              // Create a new volume meter and connect it.
              meter = createAudioMeter(audioContext);
              mediaStreamSource.connect(meter);

              // kick off the visual updating
              onLevelChange();
          }

          function onLevelChange( time ) {
              // clear the background
              canvasContext.clearRect(0,0,WIDTH,HEIGHT);

              // check if we're currently clipping
              if (meter.checkClipping())
                  canvasContext.fillStyle = "red";
              else
                  canvasContext.fillStyle = "green";

              //console.log(meter.volume);

              // draw a bar based on the current volume
              canvasContext.fillRect(0, 0, meter.volume * WIDTH * 1.4, HEIGHT);

              // set up the next visual callback
              rafID = window.requestAnimationFrame( onLevelChange );

              //checking for volume
              const volumeLevel=document.getElementById('volumeLevel');
               
              if(0.01>meter.volume)
              {
                setTimeout(function () {
                  if (0.01>meter.volume) {
                      const whichLevel="Volume Too Low! Speak Up";
                      volumeLevel.textContent=whichLevel;
                  }
                }, 2000);
              }

              if (meter.volume>0.3)
              {
                setTimeout(function () {
                  if (meter.volume>0.3) {
                      const whichLevel="Volume Too High! Speak Lower";
                      volumeLevel.textContent=whichLevel;
                  }
                }, 1000);
                setTimeout(function () {
                  const whichLevel="Good Volume";
                  volumeLevel.textContent=whichLevel;
                }, 12000);                
              }

              if (meter.volume>0.05 && meter.volume<0.3)
              {
                setTimeout(function () {
                  if (0.3>meter.volume>0.05) {
                      const whichLevel="Good Volume";
                      volumeLevel.textContent=whichLevel;
                  }
                }, 1000);
                setTimeout(function () {
                  const whichLevel="Good Volume";
                  volumeLevel.textContent=whichLevel;
                }, 12000);
              }
          }


          function createAudioMeter(audioContext,clipLevel,averaging,clipLag) {
            var processor = audioContext.createScriptProcessor(512);
            processor.onaudioprocess = volumeAudioProcess;
            processor.clipping = false;
            processor.lastClip = 0;
            processor.volume = 0;
            processor.clipLevel = clipLevel || 0.98;
            processor.averaging = averaging || 0.95;
            processor.clipLag = clipLag || 750;

            // this will have no effect, since we don't copy the input to the output,
            // but works around a current Chrome bug.
            processor.connect(audioContext.destination);

            processor.checkClipping =
              function(){
                if (!this.clipping)
                  return false;
                if ((this.lastClip + this.clipLag) < window.performance.now())
                  this.clipping = false;
                return this.clipping;
              };

            processor.shutdown =
              function(){
                this.disconnect();
                this.onaudioprocess = null;
              };

            return processor;
          }

          function volumeAudioProcess( event ) {
            var buf = event.inputBuffer.getChannelData(0);
              var bufLength = buf.length;
            var sum = 0;
              var x;

            // Do a root-mean-square on the samples: sum up the squares...
              for (var i=0; i<bufLength; i++) {
                x = buf[i];
                if (Math.abs(x)>=this.clipLevel) {
                  this.clipping = true;
                  this.lastClip = window.performance.now();
                }
                sum += x * x;
              }

              // ... then take the square root of the sum.
              var rms =  Math.sqrt(sum / bufLength);

              // Now smooth this out with the averaging factor applied
              // to the previous sample - take the max here because we
              // want "fast attack, slow release."
              this.volume = Math.max(rms, this.volume*this.averaging);
          }
        </script>
    </body>
</html>
